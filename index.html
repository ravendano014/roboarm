<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STL App</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #renderCanvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
    #sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background-color: #f0f0f0;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      border-left: 1px solid #ccc;
    }
  </style>
</head>
<body>
    <div id="sidebar">
        <h2>Properties</h2>
            <strong>Name:</strong> <span id="name"></span>
        <ul>
            <li><strong>Position:</strong> <span id="position"></span></li>
            <li><strong>Rotation:</strong> <span id="rotation"></span></li>
            <li><strong>Color:</strong> <span id="color"></span></li>
        </ul>
        <h2>Move Object</h2>
        <button>Q (↑ x Axis)</button>
        <button>A (↓ x Axis)</button>
        <button>W (↑ y Axis)</button>
        <button>S (↓ y Axis)</button>
        <button>E (↑ z Axis)</button>
        <button>D (↓ z Axis)</button>
        <br>
        <h2>Rotate Object</h2>
        <button>R (↑ x Axis)</button>
        <button>F (↓ x Axis)</button>
        <button>T (↑ y Axis)</button>
        <button>G (↓ y Axis)</button>
        <button>Y (↑ z Axis)</button>
        <button>H (↓ z Axis)</button>
        <br>
        <h2>Change Color</h2>
        <input type="color" id="colorPicker">
        <button onclick="changeColor()">Apply Color (Z)</button>
        <br>
        <button id="downloadJsonButton">Descargar JSON</button>
        <img src="model.jpg" alt="" width="200" height="200">
    </div>
  <canvas id="renderCanvas"></canvas>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script src="https://cdn.babylonjs.com/gui/babylon.gui.js"></script>
  <script>
    var canvas = document.getElementById("renderCanvas");
    var engine = new BABYLON.Engine(canvas, true);
    var scene = new BABYLON.Scene(engine);
    var camera = new BABYLON.ArcRotateCamera("camera", 1, 0.8, 10, new BABYLON.Vector3(0, 0, 0), scene);
    camera.attachControl(canvas, true);
    var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
    var jsonParts = [
  {
    "name": "excavator",
    "models": "https://raw.githubusercontent.com/ravendano014/roboarm/main/models/robotic-arm-with-5-degree-of-freedom-printed-in-3d/",
    "parts": [
      {
        "mesh_id": "ukaq",
        "mesh_name": "Ante_Brazo_01.stl",
        "position": [
          {
            "x": -24.980000000001105,
            "y": -41.97000000000022,
            "z": -89.29000000000877
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "akaq",
        "mesh_name": "Base_01.stl",
        "position": [
          {
            "x": -76.73000000000235,
            "y": 0,
            "z": 89.55000000000891
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "bkaq",
        "mesh_name": "Base_02.stl",
        "position": [
          {
            "x": -37.44000000000112,
            "y": -58.34999999999696,
            "z": -90.15000000000921
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "ykaq",
        "mesh_name": "Base_03.stl",
        "position": [
          {
            "x": -184.42999999997724,
            "y": 194.7099999999679,
            "z": -105.1600000000169
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "zkaq",
        "mesh_name": "Base_04.stl",
        "position": [
          {
            "x": -74.60000000000126,
            "y": -14.129999999999743,
            "z": -87.13000000000767
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "ckaq",
        "mesh_name": "Brazo_01.stl",
        "position": [
          {
            "x": 0,
            "y": 209.6599999999543,
            "z": 140.64000000001707
          }
        ],
        "rotation": [
          {
            "x": -0.23,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "dkaq",
        "mesh_name": "Brazo_02.stl",
        "position": [
          {
            "x": -228.15999999993747,
            "y": 0,
            "z": -152.820000000006
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "ekaq",
        "mesh_name": "Brazo_03.stl",
        "position": [
          {
            "x": -47.29999999999916,
            "y": 0,
            "z": 141.88000000001594
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "fkaq",
        "mesh_name": "Brida_Pinza_01.stl",
        "position": [
          {
            "x": -157.19000000000202,
            "y": 122.17000000002558,
            "z": -97.98000000001322
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "gkaq",
        "mesh_name": "Caja_01.stl",
        "position": [
          {
            "x": -54.1699999999978,
            "y": 0.11999999999999984,
            "z": -82.5300000000053
          }
        ],
        "rotation": [
          {
            "x": 91.34999999999486,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "hkaq",
        "mesh_name": "Caja_02.stl",
        "position": [
          {
            "x": 10.849999999999813,
            "y": -51.71999999999828,
            "z": 157.7500000000015
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "ikaq",
        "mesh_name": "Control_AnteBrazo01.stl",
        "position": [
          {
            "x": 96.14000000001228,
            "y": 297.7599999998742,
            "z": -111.78000000002028
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "jkaq",
        "mesh_name": "Control_AnteBrazo02.stl",
        "position": [
          {
            "x": -109.06000000001889,
            "y": -17.299999999999905,
            "z": 86.22000000000719
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "kkaq",
        "mesh_name": "Control_Base02.stl",
        "position": [
          {
            "x": 63.86999999999586,
            "y": -69.51999999999866,
            "z": 155.70000000000337
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "lkaq",
        "mesh_name": "Control_Base03.stl",
        "position": [
          {
            "x": 0,
            "y": -152.88000000000594,
            "z": -126.42000000002777
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "mkaq",
        "mesh_name": "Control_Base04.stl",
        "position": [
          {
            "x": 14.329999999999739,
            "y": 0,
            "z": 162.12999999999752
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "nkaq",
        "mesh_name": "Control_Brazo01.stl",
        "position": [
          {
            "x": 226.09999999993934,
            "y": 0,
            "z": 136.63000000002071
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "okaq",
        "mesh_name": "Control_Munequilla01.stl",
        "position": [
          {
            "x": -19.18000000000019,
            "y": 221.57999999994345,
            "z": -33.61000000000189
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "pkaq",
        "mesh_name": "Control_Pinza01.stl",
        "position": [
          {
            "x": 3.0899999999999856,
            "y": 221.56999999994346,
            "z": -38.160000000000984
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "qkaq",
        "mesh_name": "Engranaje_01.stl",
        "position": [
          {
            "x": 0,
            "y": 0,
            "z": 16.829999999999824
          }
        ],
        "rotation": [
          {
            "x": -86.41999999999518,
            "y": -2.174207301781701e-17,
            "z": -1.8899999999999986
          }
        ]
      },
      {
        "mesh_id": "rkaq",
        "mesh_name": "Engranaje_02.stl",
        "position": [
          {
            "x": -31.770000000002167,
            "y": 37.16000000000118,
            "z": 17.950000000000014
          }
        ],
        "rotation": [
          {
            "x": -83.99999999999532,
            "y": 7.765026077791789e-17,
            "z": 7.765026077791789e-17
          }
        ]
      },
      {
        "mesh_id": "skaq",
        "mesh_name": "Grapa_cables_01.stl",
        "position": [
          {
            "x": 115.75000000002231,
            "y": 0,
            "z": 149.27000000000922
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "tkaq",
        "mesh_name": "Grapa_cables_01.stl",
        "position": [
          {
            "x": 0,
            "y": 208.6699999999552,
            "z": 143.10000000001483
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "vkaq",
        "mesh_name": "Jaula_bolas.stl",
        "position": [
          {
            "x": -163.5899999999962,
            "y": 0,
            "z": 114.33000000002158
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "wkaq",
        "mesh_name": "Munequilla_01.stl",
        "position": [
          {
            "x": -98.48000000001348,
            "y": 0,
            "z": 98.95000000001372
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "waaq",
        "mesh_name": "Pin_Muelle.stl",
        "position": [
          {
            "x": -266.47999999990265,
            "y": 0,
            "z": -119.90000000002443
          }
        ],
        "rotation": [
          {
            "x": -0.22,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "wbaq",
        "mesh_name": "Pinza_01.stl",
        "position": [
          {
            "x": -9.409999999999837,
            "y": 221.44999999994357,
            "z": -58.909999999996856
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "wcaq",
        "mesh_name": "Pinza_02.stl",
        "position": [
          {
            "x": 21.37000000000054,
            "y": 0,
            "z": 139.54000000001807
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "wdaq",
        "mesh_name": "Pinza_03.stl",
        "position": [
          {
            "x": 0,
            "y": 0,
            "z": 18.000000000000007
          }
        ],
        "rotation": [
          {
            "x": -84.3199999999953,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "weaq",
        "mesh_name": "Pinza_04.stl",
        "position": [
          {
            "x": 188.81999999997325,
            "y": -20.98000000000048,
            "z": 146.4300000000118
          }
        ],
        "rotation": [
          {
            "x": 0,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "wfaq",
        "mesh_name": "Pinza_05.stl",
        "position": [
          {
            "x": -55.99999999999743,
            "y": 46.159999999999386,
            "z": -80.74000000000441
          }
        ],
        "rotation": [
          {
            "x": -273.7999999999835,
            "y": 1.5126270799538404e-15,
            "z": -1.5126270799538404e-15
          }
        ]
      },
      {
        "mesh_id": "wgaq",
        "mesh_name": "Tapa_rodamiento.stl",
        "position": [
          {
            "x": -11.4699999999998,
            "y": 223.77999999994145,
            "z": -144.5700000000135
          }
        ],
        "rotation": [
          {
            "x": -178.39999999998946,
            "y": 7.765026077791789e-17,
            "z": -7.765026077791789e-17
          }
        ]
      },
      {
        "mesh_id": "whaq",
        "mesh_name": "Tapa_servo.stl",
        "position": [
          {
            "x": -7.999999999999874,
            "y": 86.17000000000716,
            "z": -160.74999999999875
          }
        ],
        "rotation": [
          {
            "x": -84.1199999999953,
            "y": 0,
            "z": 0
          }
        ]
      },
      {
        "mesh_id": "wiaq",
        "mesh_name": "soporte_muelle.stl",
        "position": [
          {
            "x": -6.039999999999916,
            "y": 91.64000000000998,
            "z": 28.000000000001585
          }
        ],
        "rotation": [
          {
            "x": -180.8799999999893,
            "y": 1.5126270799538404e-15,
            "z": 7.765026077791789e-17
          }
        ]
      }
    ]
  }
];

        const localAxes = new BABYLON.AxesViewer(scene, 1);


        // Cargar y posicionar cada parte del modelo 3D "spot"
        function loadAndPositionPart(part) {
            var meshURL = jsonParts[0].models;
            var meshName = part.mesh_name;

            BABYLON.SceneLoader.ImportMesh("", meshURL, meshName, scene, function (meshes) {
                // Colocar la parte en su posición
                meshes[0].id = part.mesh_id;
                meshes[0].name = part.mesh_name;
                meshes[0].position = new BABYLON.Vector3(part.position[0].x, part.position[0].y, part.position[0].z);
                meshes[0].rotation = new BABYLON.Vector3(BABYLON.Tools.ToRadians(part.rotation[0].x), BABYLON.Tools.ToRadians(part.rotation[0].y), BABYLON.Tools.ToRadians(part.rotation[0].z));
            
                meshes[0].material = new BABYLON.StandardMaterial("material", scene);
                meshes[0].material.diffuseColor = new BABYLON.Color3.FromHexString(rgbToHex(part.color[0].r*255, part.color[0].g*255, part.color[0].b*255));
            
            });
        }


        for (var i = 0; i < jsonParts[0].parts.length; i++) {
            loadAndPositionPart(jsonParts[0].parts[i], new BABYLON.Vector3(0, 0, 0));
        }
        // console.log(scene);

        engine.runRenderLoop(function () {
            scene.render();
        });

        window.addEventListener("resize", function () {
            engine.resize();
        });


    let pickedMesh = null;
    scene.onPointerMove = function() {
        var result = scene.pick(scene.pointerX, scene.pointerY);
        if (result.pickedMesh !== pickedMesh) {            
            if (pickedMesh) {
                pickedMesh.disableEdgesRendering(); 
            }

            pickedMesh = result.pickedMesh;
            if (pickedMesh) {
                pickedMesh.edgesWidth = 40.0;
                pickedMesh.edgesColor = new BABYLON.Color4(0, 1, 0.87);
                pickedMesh.enableEdgesRendering();
                selectedMesh = pickedMesh;

                 // Mostrar propiedades en la barra lateral
                document.getElementById("name").textContent = pickedMesh.mesh_name;
                document.getElementById("position").textContent = `X: ${pickedMesh.position.x.toFixed(2)}, Y: ${pickedMesh.position.y.toFixed(2)}, Z: ${pickedMesh.position.z.toFixed(2)}`;
                document.getElementById("rotation").textContent = `X: ${BABYLON.Tools.ToDegrees(pickedMesh.rotation.x).toFixed(2)}°, Y: ${BABYLON.Tools.ToDegrees(pickedMesh.rotation.y).toFixed(2)}°, Z: ${BABYLON.Tools.ToDegrees(pickedMesh.rotation.z).toFixed(2)}°`;
                document.getElementById("color").textContent = `Color: ${pickedMesh.material ? pickedMesh.material.diffuseColor.toString() : "N/A"}`;

                window.addEventListener("keydown", function (event) {
                var speed = 0.01;
                switch (event.key) {
                    case "q":
                    pickedMesh.position.x += speed;
                    break;
                    case "a":
                    pickedMesh.position.x -= speed;
                    break;
                    case "w":
                    pickedMesh.position.y += speed;
                    break;
                    case "s":
                    pickedMesh.position.y -= speed;
                    break;
                    case "e":
                    pickedMesh.position.z += speed;
                    break;
                    case "d":
                    pickedMesh.position.z -= speed;
                    break;
                    case "r":
                    pickedMesh.rotation.x += BABYLON.Tools.ToRadians(speed);
                    break;
                    case "f":
                    pickedMesh.rotation.x -= BABYLON.Tools.ToRadians(speed);
                    break;
                    case "t":
                    pickedMesh.rotation.y += BABYLON.Tools.ToRadians(speed);
                    break;
                    case "g":
                    pickedMesh.rotation.y -= BABYLON.Tools.ToRadians(speed);
                    break;
                    case "y":
                    pickedMesh.rotation.z += BABYLON.Tools.ToRadians(speed);
                    break;
                    case "h":
                    pickedMesh.rotation.z -= BABYLON.Tools.ToRadians(speed);
                    break;
                }

                // Encuentra la parte correspondiente en jsonParts y actualiza sus propiedades
                var partIndex = jsonParts[0].parts.findIndex(function (jsonPart) {
                return jsonPart.mesh_id === pickedMesh.id;
                });

                if (partIndex !== -1) {
                    var updatedPart = jsonParts[0].parts[partIndex];
                    updatedPart.position[0].x = pickedMesh.position.x;
                    updatedPart.position[0].y = pickedMesh.position.y;
                    updatedPart.position[0].z = pickedMesh.position.z;
                    updatedPart.rotation[0].x = BABYLON.Tools.ToDegrees(pickedMesh.rotation.x);
                    updatedPart.rotation[0].y = BABYLON.Tools.ToDegrees(pickedMesh.rotation.y);
                    updatedPart.rotation[0].z = BABYLON.Tools.ToDegrees(pickedMesh.rotation.z);
                    updatedPart.color[0] = pickedMesh.material.diffuseColor;
                }
                // console.log(jsonParts);

                });
            
            }
        }
    };

// Función para recopilar la información actualizada de las partes y descargar el JSON
function downloadJson() {
  // console.log(scene);
  const updatedParts = jsonParts[0].parts.map((part) => {
    const mesh = scene.getMeshByID(part.mesh_id);
    return {
      mesh_id: part.mesh_id,
      mesh_name: part.mesh_name,
      position:  [{
        x: mesh.position.x,
        y: mesh.position.y,
        z: mesh.position.z,
      }],
      rotation: [{
        x: BABYLON.Tools.ToDegrees(mesh.rotation.x),
        y: BABYLON.Tools.ToDegrees(mesh.rotation.y),
        z: BABYLON.Tools.ToDegrees(mesh.rotation.z),
      }],
      color: [mesh.material.diffuseColor]
    };
  });

  const jsonContent = JSON.stringify(updatedParts, null, 2);
  const blob = new Blob([jsonContent], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  // Crear un enlace para la descarga
  const downloadLink = document.createElement("a");
  downloadLink.href = url;
  downloadLink.download = "spot.json";
  downloadLink.click();

  // Liberar la URL del objeto Blob
  URL.revokeObjectURL(url);
}

// Asigna la función downloadJson al botón de descarga
document.getElementById("downloadJsonButton").addEventListener("click", downloadJson);

document.addEventListener("keydown", function (event) {
    if (event.key === "z") {
        // Llama a la función changeColor() al presionar la tecla "Z"
        changeColor();
    }
});

function changeColor() {
    const colorPicker = document.getElementById("colorPicker");
    const selectedColor = colorPicker.value;

    if (pickedMesh) {
        // Cambiar el color del material de la parte seleccionada
        pickedMesh.material = new BABYLON.StandardMaterial("material", scene);
        pickedMesh.material.diffuseColor = new BABYLON.Color3.FromHexString(selectedColor);
    }
}

function rgbToHex(r, g, b) {
    const toHex = (value) => {
        const hex = value.toString(16);
        return hex.length === 1 ? "0" + hex : hex;
    };
    
    const red = toHex(r);
    const green = toHex(g);
    const blue = toHex(b);
    
    return "#" + red + green + blue;
}

function hexToRgb(hex) {
    const trimmedHex = hex.replace(/^#/, "");
    
    if (trimmedHex.length === 3) {
        const r = parseInt(trimmedHex[0], 16) * 17;
        const g = parseInt(trimmedHex[1], 16) * 17;
        const b = parseInt(trimmedHex[2], 16) * 17;
        return { r, g, b };
    } else if (trimmedHex.length === 6) {
        const r = parseInt(trimmedHex.substring(0, 2), 16);
        const g = parseInt(trimmedHex.substring(2, 4), 16);
        const b = parseInt(trimmedHex.substring(4, 6), 16);
        return { r, g, b };
    }
    
    throw new Error("#000000");
}
    </script>
</body>
</html>
